#!/bin/bash -e

export KERNEL_VERSION=6.8
export BUSYBOX_VERSION=1.36.1

#
# dependencies
#
echo "[+] Checking / installing dependencies..."
# sudo apt-get -q update
# sudo apt-get -q install -y bc bison flex libelf-dev cpio build-essential libssl-dev qemu-system-x86

#
# linux kernel
#
echo "[+] Downloading kernel..."
wget -q -c https://mirrors.edge.kernel.org/pub/linux/kernel/v6.x/linux-$KERNEL_VERSION.tar.gz
[ -e linux-$KERNEL_VERSION ] || tar xzf linux-$KERNEL_VERSION.tar.gz

echo "[+] Copying kernel config..."
cp .config linux-$KERNEL_VERSION/

sed -i 'N;s/WARN("missing symbol table");\n\t\treturn -1;/\n\t\treturn 0;\n\t\t\/\/ A missing symbol table is actually possible if its an empty .o file.  This can happen for thunk_64.o./g' linux-$KERNEL_VERSION/tools/objtool/elf.c

sed -i 's/unsigned long __force_order/\/\/ unsigned long __force_order/g' linux-$KERNEL_VERSION/arch/x86/boot/compressed/pgtable_64.c

echo "[+] Building the kernel..."
make -C linux-$KERNEL_VERSION -j16 bzImage
echo "[+] Building kernel library for modules..."
make -C linux-$KERNEL_VERSION -j16 modules 

#
# Busybox
#

echo "[+] Downloading busybox..."
wget -q -c https://busybox.net/downloads/busybox-$BUSYBOX_VERSION.tar.bz2
[ -e busybox-$BUSYBOX_VERSION ] || tar xjf busybox-$BUSYBOX_VERSION.tar.bz2

echo "[+] Building busybox..."
make -C busybox-$BUSYBOX_VERSION defconfig
sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/g' busybox-$BUSYBOX_VERSION/.config
sed -i 's/CONFIG_TC=y/CONFIG_TC=n/g' busybox-$BUSYBOX_VERSION/.config
make -C busybox-$BUSYBOX_VERSION -j16
make -C busybox-$BUSYBOX_VERSION install

#
# filesystem
#

echo "[+] Building filesystem..."
cd fs
mkdir -p bin sbin etc proc sys usr/bin usr/sbin root home/ctf tmp
chmod 777 tmp
cd ..
cp -a busybox-$BUSYBOX_VERSION/_install/* fs


#
# modules
# #
#
echo "[+] Building modules..."
cd src
make
cd ..

echo "[+] Copying kernel modules to filesystem..."
cp src/*.ko fs


echo "[+] Building exploits..."
cd exploits 
make
cd ..

echo "[+] Creating shared directory..."
mkdir -p ./shared

echo "[+] Copying exploits to filesystem in /home/ctf"
cp exploits/*.elf ./shared/
