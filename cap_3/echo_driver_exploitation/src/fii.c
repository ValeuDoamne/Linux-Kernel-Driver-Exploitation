#include <linux/printk.h>
#include <linux/module.h>
#include <linux/version.h>
#include <linux/proc_fs.h>
#include <linux/string.h>
#include <linux/reboot.h>


#define DEVICE_NAME "fii"
#define BUFFER_SIZE 256
#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 6, 0)
#define HAVE_PROC_OPS
#endif

static struct proc_dir_entry *proc_file;

struct user_data {
    char buffer[BUFFER_SIZE];
    int (*print_function)(const char *buffer, ...); 
};

static struct user_data *GLOBAL_DATA;

static ssize_t read_op(struct file* fp, char __user *buffer, size_t length, loff_t *offset) {
    if(copy_to_user(buffer, GLOBAL_DATA->buffer, length)) {
        printk(KERN_ERR "Could not copy to the user buffer!\n");
        return 0;
    }
    return length;
}

static ssize_t write_op(struct file* fp, const char __user *buffer, size_t length, loff_t *offset) {
    if (copy_from_user(GLOBAL_DATA->buffer, buffer, length)) {
        printk(KERN_ERR "Could not write into kernel memory the buffer provided!\n");
        return 0;
    }
    if (GLOBAL_DATA->print_function != NULL) {
        GLOBAL_DATA->print_function(GLOBAL_DATA->buffer);
    }
    return length;
}


#ifdef HAVE_PROC_OPS 
static const struct proc_ops proc_fops = { 
    .proc_read = read_op, 
    .proc_write = write_op,
}; 
#else 
static const struct file_operations proc_fops = { 
    .read = read_op, 
    .write = write_op,
}; 
#endif

int init_module(void) {
    // Set the permission to read/write for everyone 
    proc_file = proc_create(DEVICE_NAME, 0666, NULL, &proc_fops);
    GLOBAL_DATA = (struct user_data *)kmalloc(sizeof(struct user_data), GFP_KERNEL);
    if (GLOBAL_DATA == NULL) {
        printk (KERN_ERR "Could not allocate memory for the object!\n");
        return -ENOMEM;
    }
    // Set the function to printk for now
    GLOBAL_DATA->print_function = (int (*)(const char *, ...))(_printk);
    if (proc_file == NULL) {
        proc_remove(proc_file);
        printk(KERN_ERR "Error could not initiate: /proc/" DEVICE_NAME "\n");
        return -ENOMEM;
    }
    return 0;
}

void cleanup_module(void) {
    proc_remove(proc_file);
    kfree(GLOBAL_DATA);
    printk(KERN_INFO "Successfully removed the device /proc/" DEVICE_NAME "!\n");
}

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Cosmin Alexa");
